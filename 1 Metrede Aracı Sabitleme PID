PÄ°XHAWK 2.4.8 Ä°Ã‡Ä°N


from pymavlink import mavutil
import time
time.sleep(15)

# âœ… BaÅŸlangÄ±Ã§ta 15 saniye bekle (Pixhawk aÃ§Ä±lmasÄ± iÃ§in)
print("â³ Pixhawk aÃ§Ä±lmasÄ± iÃ§in 15 saniye bekleniyor...")

# âœ… Pixhawk baÄŸlantÄ±sÄ±nÄ± baÅŸlat (portu sistemine gÃ¶re deÄŸiÅŸtir)
print("ğŸ“¡ Pixhawk baÄŸlantÄ±sÄ± bekleniyor...")
master = mavutil.mavlink_connection('/dev/ttyACM0', baud=57600)
master.wait_heartbeat()
print("âœ… Pixhawk baÄŸlantÄ±sÄ± kuruldu!")

# ğŸ”’ MotorlarÄ± ARM ET (gÃ¼venlik nedeniyle baÄŸlantÄ±dan hemen sonra)
master.arducopter_arm()
master.motors_armed_wait()
print("âœ… Motorlar ARM edildi!")

# PID sabitleri
Kp = 900.0
Ki = 65.0
Kd = 1000.0

hedef_derinlik = 1.0  # metre cinsinden, 5 cm
integral = 0.0
previous_error = 0.0
last_time = time.time()

P0 = -1  # ilk atmosfer basÄ±ncÄ±

# PWM gÃ¶nderme fonksiyonu
def pwm_gonder(motor_no, pwm):
    pwm = max(min(pwm, 1900), 1100)
    master.mav.command_long_send(
        target_system=1,
        target_component=1,
        command=mavutil.mavlink.MAV_CMD_DO_SET_SERVO,
        confirmation=0,
        param1=motor_no,
        param2=pwm,
        param3=0,
        param4=0,
        param5=0,
        param6=0,
        param7=0
    )
    print(f"âš™ï¸ motor{motor_no} â†’ {pwm} PWM")

# BasÄ±nÃ§tan derinlik hesaplama
def hesapla_derinlik(basinc_hPa):
    global P0
    rho = 997.0
    g = 9.80665
    if P0 < 0:
        P0 = basinc_hPa
        print(f"ğŸ”§ Ä°lk basÄ±nÃ§ P0: {P0:.2f} hPa")

    P = (basinc_hPa - P0) * 100.0
    h = P / (rho * g)
    return max(h, 0)

# PID kontrol ve motorlara PWM gÃ¶nderme
def kontrol_motor_pid(olculen_derinlik):
    global integral, previous_error, last_time
    now = time.time()
    dt = now - last_time
    if dt <= 0.005:
        return
    last_time = now

    error = hedef_derinlik - olculen_derinlik
    integral += error * dt
    derivative = (error - previous_error) / dt
    previous_error = error

    output = Kp * error + Ki * integral + Kd * derivative

    if abs(output) < 100 and abs(error) > 0.005:
        output = 70 if output > 0 else -100

    pwm = int(1500 + output)
    print(f"ğŸ“ Derinlik: {olculen_derinlik:.3f} m | PWM: {pwm}")
    pwm_gonder(5, pwm)  # Ã–n saÄŸ
    pwm_gonder(6, pwm)  # Ã–n sol
    pwm_gonder(7, pwm)  # Arka saÄŸ
    pwm_gonder(8, pwm)  # Arka sol


# ğŸ” Ana dÃ¶ngÃ¼
print("ğŸ” BasÄ±nÃ§ dinleniyor...")
while True:
    msg = master.recv_match(type='SCALED_PRESSURE2', blocking=True, timeout=5)
    if msg is None:
        print("âš ï¸ SCALED_PRESSURE2 verisi alÄ±namadÄ±! Pixhawk parametrelerini kontrol et.")
        continue

    basinc_hPa = msg.press_abs
    derinlik = hesapla_derinlik(basinc_hPa)
    kontrol_motor_pid(derinlik)
