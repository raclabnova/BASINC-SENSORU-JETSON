****** PÄ°XHAWK CUBE ORANGE Ä°Ã‡Ä°N 1M SABÄ°TLEME KODU

from pymavlink import mavutil
import time

print("â³ Pixhawk aÃ§Ä±lmasÄ± iÃ§in 15 saniye bekleniyor...")
time.sleep(15)

# Pixhawk baÄŸlantÄ±sÄ±
print("ğŸ“¡ Pixhawk baÄŸlantÄ±sÄ± bekleniyor...")
master = mavutil.mavlink_connection('/dev/ttyACM0', baud=57600)
master.wait_heartbeat()
print("âœ… Pixhawk baÄŸlantÄ±sÄ± kuruldu!")

# AHRS2 mesajÄ±nÄ± aktif et
master.mav.command_long_send(
    target_system=1,
    target_component=1,
    command=mavutil.mavlink.MAV_CMD_SET_MESSAGE_INTERVAL,
    confirmation=0,
    param1=178,           # AHRS2 ID
    param2=200000,        # 200ms = 5Hz
    param3=0, param4=0, param5=0, param6=0, param7=0
)
print("ğŸ“¡ AHRS2 mesajÄ± aktif edildi!")

# MotorlarÄ± ARM et
master.arducopter_arm()
master.motors_armed_wait()
print("âœ… Motorlar ARM edildi!")

# PID sabitleri
Kp = 850.0
Ki = 65.0
Kd = 1000.0

hedef_derinlik = 0.7  # 1 metre hedef
integral = 0.0
previous_error = 0.0
last_time = time.time()
ilk_altitude = None

# PWM gÃ¶nderme
def pwm_gonder(motor_no, pwm):
    pwm = max(min(pwm, 1900), 1100)
    master.mav.command_long_send(
        target_system=1,
        target_component=1,
        command=mavutil.mavlink.MAV_CMD_DO_SET_SERVO,
        confirmation=0,
        param1=motor_no,
        param2=pwm,
        param3=0,
        param4=0,
        param5=0,
        param6=0,
        param7=0
    )
    print(f"âš™ï¸ motor{motor_no} â†’ {pwm} PWM")

# PID kontrol
def kontrol_motor_pid(derinlik):
    global integral, previous_error, last_time
    now = time.time()
    dt = now - last_time
    if dt <= 0.005:
        return
    last_time = now

    error = hedef_derinlik - derinlik  # 1m altÄ±ndaysa hata pozitif
    integral += error * dt
    derivative = (error - previous_error) / dt
    previous_error = error

    output = Kp * error + Ki * integral + Kd * derivative

    # Ufak hatalarda kÃ¼Ã§Ã¼k kuvvet uygula
    if abs(output) < 100 and abs(error) > 0.01:
        output = 70 if output > 0 else -100

    pwm = int(1500 + output)
    pwm = max(min(pwm, 1900), 1100)

    print(f"ğŸ“ GÃ¶reli Derinlik: {derinlik:.3f} m | Hedef: {hedef_derinlik:.2f} m | PWM: {pwm}")
    for motor in [5, 6, 7, 8]:
        pwm_gonder(motor, pwm)

# AHRS2 dinle ve gÃ¶reli derinlik hesapla
print("ğŸ” AHRS2 mesajlarÄ± dinleniyor...")
while True:
    msg = master.recv_match(type='AHRS2', blocking=True, timeout=5)
    if msg is None:
        print("âš ï¸ AHRS2 verisi alÄ±namadÄ±!")
        continue

    altitude = msg.altitude
    if ilk_altitude is None:
        ilk_altitude = altitude
        print(f"ğŸ“ BaÅŸlangÄ±Ã§ altitudesi referans alÄ±ndÄ±: {ilk_altitude:.2f} m")

    # GÃ¶reli derinlik: ne kadar aÅŸaÄŸÄ± indik?
    derinlik = ilk_altitude - altitude

    kontrol_motor_pid(derinlik)
